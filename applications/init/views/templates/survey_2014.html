{{import urllib}}
{{import pydal.objects}}
{{from collections import OrderedDict}}
{{left_sidebar_enabled,right_sidebar_enabled=True,False}}
{{extend 'layout.html'}}

{{block head}}
    {{super}}
    <link rel="stylesheet" href="{{=URL('static','css/custom/bootstrap-multiselect.css')}}"/>
    <link type="text/css" rel="stylesheet" href="{{=URL('static','home/font-awesome/css/font-awesome.min.css')}}"/>
{{end}}

{{block header}}
<header style="text-align: center; padding-bottom:1px;">
    {{# <h3>A. Spencer MD (MDLand)</h3>  {{#practice}}
    {{app_row = db((db.application.id == APP_ID) & (db.application.owner_id == db.auth_user.id)).select().last()}}
    <h3>{{=app_row.application.practice_name}}</h3>  {{#practice}}
    <h4>
        {{_practice_address = "%s%s, %s, %s %s" % (app_row.application.practice_address_line_1,
                                                   ", %s" % app_row.application.practice_address_line_2 if app_row.application.practice_address_line_2 else "",
                                                   app_row.application.practice_city,
                                                   app_row.application.practice_state,
                                                   app_row.application.practice_zip,
                                                  )
          if not IS_STAFF:
            _map_query = urllib.urlencode({'q':'660 White Plains Rd #325, Tarrytown, NY 10573'})
          else:
            _map_query = urllib.urlencode({'f':'d', 'saddr': INSIGHT_ADDR, 'daddr':_practice_address})
          pass
        }}
        <span class="glyphicon glyphicon-map-marker"></span><span class="visible-print-inline">{{=_practice_address}}</span><a class="hidden-print" href="http://maps.google.com/?{{=_map_query}}">{{=_practice_address}}</a>  {{#}}
    </h4>  {{#address}} {{# http://bit.ly/2a59inp}}
    <h5>
    <span class="glyphicon glyphicon-earphone"></span> {{=app_row.application.practice_phone}} <span style="opacity:0.2">|</span>
    <span class="fa fa-fax"></span> {{=app_row.application.practice_fax}} <span style="opacity:0.2">|</span>
    {{# <span class="glyphicon glyphicon-envelope"></span> <a href="mailto:allison@insightmanagement.org">allison@insightmanagement.org</a>}}
    <span class="glyphicon glyphicon-envelope"></span> <a href="mailto:{{=app_row.auth_user.email}}" class="text-capitalize">{{=app_row.auth_user.first_name}} {{=app_row.auth_user.last_name}} (primary contact)</a>
    </h5>
</header>
{{end}}

{{block left_sidebar}}
<ul class="nav nav-pills nav-stacked hidden-print">
    {{_pcmh = request.nav.get_pcmh_from_request()
    _element = request.nav.get_element_from_request()
    _elements = request.nav[_pcmh]['elements']
    _element_list = sorted(map(lambda e: _elements[e], _elements), key=lambda i: i.label)}}
    {{for e_storage in _element_list:}}
        <li role="presentation" {{if _element==e_storage.element:}}class="active"{{pass}}><a href="{{=e_storage.url}}">{{=e_storage.description}}</a></li> {{# credit card http://stackoverflow.com/questions/1146810/taking-credit-card-information-online-without-processing-how-best-to-do-so}}
    {{pass}}
</ul>
{{end}}

{{def QUESTION_PANEL(qna):}}
{{if qna.show:}}
<div id="{{=qna.table_name}}" class="panel panel-{{if qna.needs_answer():}}primary{{elif qna.has_warnings():}}warning{{else:}}default{{pass}}">
    <div class="panel-heading question-box-heading"><span class="pull-right">&emsp;<span class="glyphicon glyphicon-{{if qna.needs_answer():}}unchecked{{elif qna.has_warnings():}}edit{{else:}}check{{pass}}" title="{{if qna.needs_answer():}}Incomplete{{elif qna.has_warnings():}}Needs Attention{{else:}}Answered{{pass}}"></span></span>
        <span class="glyphicon glyphicon-asterisk {{if qna.needs_answer() or qna.has_warnings():}}fa-spin{{pass}}"></span>&nbsp;{{=qna.question}}</div>
    <div class="panel-body">
    {{for warning in qna.warnings:}}
        <blockquote class="text-danger">{{=warning}}</blockquote>
    {{pass}}
    {{if qna.rows:}}
        <h5>
        {{_bullet="ul" if qna.limit==1 else "ol"}}
        {{=XML("<"+_bullet+">")}}
        {{for rendered in qna.render_template():}}
            <li>{{=rendered}}</li>
        {{pass}}
        {{=XML("</"+_bullet+">")}}
        </h5>
        <br>
    {{pass}}
    {{=qna.form}}
    <small class="text-muted pull-left text-uppercase hidden-print"><i>#{{=qna.table_name}}</i></small>
    {{=TAG.button(SPAN(_class='glyphicon glyphicon-comment', _style="color: #BA55D3"),
        _title="Leave a question or comment regarding #%s" % qna.table_name,
        _class="btn btn-sm btn-secondary pull-right hidden-print", _type="button",  # button needed else submit
        _onclick="askForHelp('%s');" % qna.table_name)
    }}
    </div>
</div>
{{pass}}
{{return}}

{{
        actions = []
        show_generic = False
        if any(map(lambda e: e.needs_answer(), QNA.instances)):
            actions.append(XML(T("Please <b class='text-info'>answer</b> one or more questions below.")))
            actions.append(XML(T("Note, some questions need more than one answer in order to be considered complete.")))
        pass
        if any(map(lambda e: e.has_warnings(), QNA.instances)):
            actions.append(XML(T("Please <b class='text-warning'>resolve</b> one or more questions below.")))
        pass
        if actions:
            actions.append(XML(T("If you feel stuck at any point, please contact your trainer.")))
        pass
        has_action = bool(actions)
}}

<div class="panel panel-primary panel-{{if has_action:}}danger{{else:}}success{{pass}}">
    <div class="panel-heading question-box-heading" style="text-transform: none; font-size:17px"><a href="javascript:void(0);" class="pull-right hidden-print" title="Print page" style="color:white;" onclick="Tawk_API.hideWidget();"><span class="glyphicon glyphicon-print"></span></a><span class="glyphicon glyphicon-{{if not has_action:}}ok-sign{{else:}}exclamation-sign{{pass}}"></span> {{if has_action:}}Action{{="s" if len(actions)>1 else ""}} needed...{{else:}}Success!{{pass}}</div>
    <div class="panel-body">
        <ul>
            {{for action in actions:}}
                <li>{{=action}}</li>
            {{pass}}
            {{if not has_action:}}
                <li>You have completed this section!</li>
                {{for doc in documents:}}
                    <li>Download <a href="{{=doc[1]}}">{{=doc[0]}}</a></li>
                {{pass}}
            {{pass}}
        </ul>
    </div>
</div>

{{for qna in reversed(QNA.instances):}}

    {{QUESTION_PANEL(qna)}}

{{pass}}

{{block right_sidebar}}
{{end}}

{{block page_js}}
{{super}}
<script>
    $(".panel-body").each(function(){
        $(this).css({visibility: hidden});
        $(this).animate({visibility:visible});
    })
</script>

<script src="{{=URL('static','js/custom/bootstrap-multiselect.js')}}"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("[multiple='multiple'][class!='autocomplete']").multiselect({maxHeight:250});
    });
</script>

<!--set tooltip-->
<script>
    $('[title]').tooltip({'html': true});
</script>

<!--Start of Tawk.to Script-->
{{import hashlib, hmac}}
<script type="text/javascript">
    var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
    <!--Set Talk.to variables-->
    Tawk_API.visitor  = {  {{# go to admin > property settings > enable secure js api > ok to always force secure mode}}
        'name': '{{="%s %s"%(auth.user.first_name.capitalize(), auth.user.last_name.capitalize())}}',
        'email': '{{=auth.user.email}}', {{# secure mode ensures that an evil script did not change the username}}
        'hash': '{{=hmac.new(TALK_TO_API_KEY, msg=auth.user.email, digestmod=hashlib.sha256).hexdigest()}}'
    };
    (function () {
        var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
        s1.async = true;
        s1.src = 'https://embed.tawk.to/580000caa420952046850bff/default';
        s1.charset = 'UTF-8';
        s1.setAttribute('crossorigin', '*');
        s0.parentNode.insertBefore(s1, s0);
    })();
</script>

<script>
    function askForHelp(tablename){
        Tawk_API.setAttributes({
            'last-question-id': tablename,
            'practice-name': "{{=app_row.application.practice_name}}",
            'app-id': "{{=APP_ID}}",
            'user-id': "{{=auth.user.id}}",
            'pcmh': "{{=request.controller}}", {{#todo}}
            'element': "{{=request.function}}"
        }, function(error){if (error){alert("Chat error:\n"+error);}});
        Tawk_API.showWidget();
        Tawk_API.maximize();
    }
    Tawk_API.onBeforeLoad = function(){
        askForHelp('none');
    };
</script>

<!--End of Tawk.to Script-->

<script>
    Tawk_API.onChatHidden = function(){
            $(".form-control").addClass("hidden-print");
            $("[title]").tooltip('hide');
            $(".w2p_flash").addClass("hidden-print");  {{# hide web2py flash}}
            window.print();
    };
</script>

<script src="{{=URL('static','js/custom/_fixes.js')}}"></script>
{{end page_js}}